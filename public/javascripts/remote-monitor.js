// Generated by CoffeeScript 1.7.1
var ns;

ns = (function() {
  var debug, exports, host, path, port;
  exports = {};
  host = '192.168.1.122';
  port = 9000;
  path = '/remote-monitor';
  debug = 3;
  exports.RemoteMonitor = (function() {
    function RemoteMonitor() {
      console.log("constructor");
      this.peer = new Peer({
        host: host,
        port: port,
        path: path,
        debug: debug
      });
    }

    RemoteMonitor.prototype.initialize = function(video, initializing, waiting) {
      console.log("initialize");
      initializing();
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      return navigator.getUserMedia({
        audio: true,
        video: true
      }, (function(_this) {
        return function(stream) {
          console.log("getUserMedia success");
          video.prop('src', URL.createObjectURL(stream));
          _this.ls = stream;
          _this.ls.getAudioTracks()[0].enabled = false;
          return waiting();
        };
      })(this), (function(_this) {
        return function() {
          console.log("getUserMedia fail");
          return console.log("ビデオカメラとマイクへのアクセスに失敗しました");
        };
      })(this));
    };

    RemoteMonitor.prototype.onOpen = function(peerIDsetting) {
      console.log("onOpen");
      return this.peer.on('open', (function(_this) {
        return function() {
          console.log("peer.open");
          return peerIDsetting(_this.peer.id);
        };
      })(this));
    };

    RemoteMonitor.prototype.onError = function(showError, waiting) {
      console.log("onError");
      return this.peer.on('error', (function(_this) {
        return function(err) {
          console.log("peer.error: " + err.message);
          showError(err.message);
          return waiting();
        };
      })(this));
    };

    RemoteMonitor.prototype.onConnection = function(messageHandler, imageHandler) {
      if (messageHandler == null) {
        messageHandler = null;
      }
      if (imageHandler == null) {
        imageHandler = null;
      }
      console.log("onConnection");
      return this.peer.on('connection', (function(_this) {
        return function(conn) {
          console.log("peer.connection");
          return conn.on('data', function(data) {
            console.log("conn.data " + data);
            if (/^event:(.*)/.exec(data)) {
              console.log("event received:" + RegExp.$1);
              return _this.__eventHandler(RegExp.$1);
            } else if (/^message:(.*)/.exec(data)) {
              console.log("message received:" + RegExp.$1);
              if (messageHandler) {
                return messageHandler(RegExp.$1);
              }
            } else if (/^data:(.*)/.exec(data)) {
              console.log("data received:" + RegExp.$1);
              if (imageHandler) {
                return imageHandler(RegExp.$1);
              }
            } else {
              return console.log("unknown data received:" + data);
            }
          });
        };
      })(this));
    };

    RemoteMonitor.prototype.onCall = function(video, connecting, waiting) {
      console.log("onCall");
      return this.peer.on('call', (function(_this) {
        return function(call) {
          console.log("peer.call");
          call.answer(_this.ls);
          _this.__connect(call, video, waiting);
          return connecting();
        };
      })(this));
    };

    RemoteMonitor.prototype.makeCall = function(callto, video, connecting, waiting) {
      var call;
      console.log("makeCall : " + callto);
      this.callto = callto;
      call = this.peer.call(callto, this.ls);
      this.__connect(call, video, waiting);
      return connecting();
    };

    RemoteMonitor.prototype.closeCall = function() {
      console.log("closeCall");
      return this.ec.close();
    };

    RemoteMonitor.prototype.toggleMIC = function() {
      var state;
      state = this.ls.getAudioTracks()[0].enabled;
      console.log("toggleMIC state:" + state);
      this.ls.getAudioTracks()[0].enabled = !state;
      if (state) {
        return this.__send("event:mic-off");
      } else {
        return this.__send("event:mic-on");
      }
    };

    RemoteMonitor.prototype.sendMessage = function(message) {
      console.log("sendMessage: " + message);
      return this.__send("message:" + message);
    };

    RemoteMonitor.prototype.sendData = function(data) {
      console.log("sendData: " + data);
      return this.__send("data:" + data);
    };

    RemoteMonitor.prototype.clearCapture = function() {
      console.log("clearCapture");
      return this.__send("data:clear-capture");
    };

    RemoteMonitor.prototype.terminate = function() {
      console.log("terminate");
      return this.peer.destroy();
    };

    RemoteMonitor.prototype.__connect = function(call, video, waiting) {
      console.log("__connect");
      if (this.ec != null) {
        this.ec.close();
      }
      call.on('stream', (function(_this) {
        return function(stream) {
          console.log("call.stream");
          return video.prop('src', URL.createObjectURL(stream));
        };
      })(this));
      call.on('close', function() {
        console.log("call.close");
        return waiting();
      });
      return this.ec = call;
    };

    RemoteMonitor.prototype.__send = function(data) {
      var conn, head;
      head = data.length < 20 ? data : "" + (data.substring(0, 20)) + "...";
      conn = this.peer.connect(this.callto, {
        reliable: true
      });
      return conn.on('open', (function(_this) {
        return function() {
          conn.send(data);
          return console.log("sent data:" + head);
        };
      })(this));
    };

    RemoteMonitor.prototype.__eventHandler = function(event) {
      console.log("__eventHandler event:" + event);
      switch (event) {
        case 'mic-on':
          console.log("event: mic-on");
          return this.ls.getAudioTracks()[0].enabled = true;
        case 'mic-off':
          console.log("event: mic-off");
          return this.ls.getAudioTracks()[0].enabled = false;
        default:
          return console.log("event: unknown");
      }
    };

    return RemoteMonitor;

  })();
  return exports;
})();
