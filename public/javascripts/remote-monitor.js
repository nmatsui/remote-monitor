// Generated by CoffeeScript 1.7.1
var ns,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

ns = (function() {
  var BaseClass, DEBUG, HOST, PATH, PORT, exports;
  exports = {};
  HOST = '192.168.1.122';
  PORT = 9000;
  PATH = '/remote-monitor';
  DEBUG = 3;
  BaseClass = (function() {
    function BaseClass() {
      console.log("constructor of BaseClass");
      this.peer = new Peer({
        host: HOST,
        port: PORT,
        path: PATH,
        debug: DEBUG
      });
      this.ls = null;
      this.emc = null;
      this.edc = null;
      this.eh = null;
    }

    BaseClass.prototype.initialize = function(video, initializing, waiting) {
      console.log("initialize");
      initializing();
      navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
      return navigator.getUserMedia({
        audio: true,
        video: true
      }, (function(_this) {
        return function(stream) {
          console.log("getUserMedia success");
          video.prop('src', URL.createObjectURL(stream));
          _this.ls = stream;
          _this.ls.getAudioTracks()[0].enabled = false;
          return waiting();
        };
      })(this), (function(_this) {
        return function() {
          console.log("getUserMedia fail");
          if (_this.eh != null) {
            return _this.eh("getUserMedia fail");
          }
        };
      })(this));
    };

    BaseClass.prototype.onError = function(showError, waiting) {
      console.log("onError");
      this.eh = showError;
      return this.peer.on('error', (function(_this) {
        return function(err) {
          console.log("peer.error: " + err.message);
          if (_this.eh != null) {
            _this.eh("peer.error: " + err.message);
          }
          return waiting();
        };
      })(this));
    };

    BaseClass.prototype.closeCall = function() {
      console.log("closeCall");
      if (this.emc != null) {
        this.emc.close();
      }
      if (this.edc != null) {
        return this.edc.close();
      }
    };

    BaseClass.prototype.terminate = function() {
      console.log("terminate");
      if (this.emc != null) {
        this.emc.close();
      }
      if (this.edc != null) {
        this.edc.close();
      }
      if (this.peer != null) {
        return this.peer.destroy();
      }
    };

    BaseClass.prototype.__connect = function(mediaConnection, video, waiting) {
      console.log("__connect");
      if (this.emc != null) {
        this.emc.close();
      }
      mediaConnection.on('stream', (function(_this) {
        return function(stream) {
          console.log("mediaConnection.stream");
          return video.prop('src', URL.createObjectURL(stream));
        };
      })(this));
      mediaConnection.on('close', function() {
        console.log("mediaConnection.close");
        return waiting();
      });
      return this.emc = mediaConnection;
    };

    return BaseClass;

  })();
  exports.MonitorClass = (function(_super) {
    __extends(MonitorClass, _super);

    function MonitorClass() {
      console.log("constructor of MonitorClass");
      MonitorClass.__super__.constructor.call(this);
    }

    MonitorClass.prototype.makeCall = function(callto, video, connecting, waiting) {
      var dataConnection, mediaConnection;
      console.log("makeCall : " + callto);
      this.callto = callto;
      mediaConnection = this.peer.call(callto, this.ls);
      this.__connect(mediaConnection, video, waiting);
      dataConnection = this.peer.connect(callto, {
        reliable: true
      });
      dataConnection.on('open', (function(_this) {
        return function() {
          console.log("dataConnection.open");
          if (_this.edc != null) {
            _this.edc.close();
          }
          return _this.edc = dataConnection;
        };
      })(this));
      dataConnection.on('close', function() {
        return console.log("dataConnection.close");
      });
      return connecting();
    };

    MonitorClass.prototype.toggleMIC = function() {
      var state;
      state = this.ls.getAudioTracks()[0].enabled;
      console.log("toggleMIC state:" + state);
      this.ls.getAudioTracks()[0].enabled = !state;
      if (state) {
        return this.__send("event:mic-off");
      } else {
        return this.__send("event:mic-on");
      }
    };

    MonitorClass.prototype.sendMessage = function(message) {
      console.log("sendMessage: " + message);
      return this.__send("message:" + message);
    };

    MonitorClass.prototype.sendData = function(data) {
      console.log("sendData: " + data);
      return this.__send("data:" + data);
    };

    MonitorClass.prototype.__send = function(data) {
      var head;
      head = data.length < 20 ? data : "" + (data.substring(0, 20)) + "...";
      if ((this.edc != null) && this.edc.open) {
        this.edc.send(data);
        return console.log("sent data:" + head);
      } else {
        console.log("dataConnection is lost");
        if (this.eh != null) {
          return this.eh("dataConnection is lost");
        }
      }
    };

    return MonitorClass;

  })(BaseClass);
  exports.DeviceClass = (function(_super) {
    __extends(DeviceClass, _super);

    function DeviceClass() {
      console.log("constructor of DeviceClass");
      DeviceClass.__super__.constructor.call(this);
    }

    DeviceClass.prototype.onOpen = function(peerIDsetting) {
      console.log("onOpen");
      return this.peer.on('open', (function(_this) {
        return function() {
          console.log("peer.open");
          return peerIDsetting(_this.peer.id);
        };
      })(this));
    };

    DeviceClass.prototype.onConnection = function(messageHandler, imageHandler) {
      if (messageHandler == null) {
        messageHandler = null;
      }
      if (imageHandler == null) {
        imageHandler = null;
      }
      console.log("onConnection");
      return this.peer.on('connection', (function(_this) {
        return function(dataConnection) {
          console.log("peer.connection");
          if (_this.edc != null) {
            _this.edc.close;
          }
          _this.edc = dataConnection;
          return _this.edc.on('data', function(data) {
            console.log("dataConnection.data " + data);
            if (/^event:(.*)/.exec(data)) {
              console.log("event received:" + RegExp.$1);
              return _this.__eventHandler(RegExp.$1);
            } else if (/^message:(.*)/.exec(data)) {
              console.log("message received:" + RegExp.$1);
              if (messageHandler) {
                return messageHandler(RegExp.$1);
              }
            } else if (/^data:(.*)/.exec(data)) {
              console.log("data received:" + RegExp.$1);
              if (imageHandler) {
                return imageHandler(RegExp.$1);
              }
            } else {
              return console.log("unknown data received:" + data);
            }
          });
        };
      })(this));
    };

    DeviceClass.prototype.onCall = function(video, connecting, waiting) {
      console.log("onCall");
      return this.peer.on('call', (function(_this) {
        return function(mediaConnection) {
          console.log("peer.call");
          mediaConnection.answer(_this.ls);
          _this.__connect(mediaConnection, video, waiting);
          return connecting();
        };
      })(this));
    };

    DeviceClass.prototype.__eventHandler = function(event) {
      console.log("__eventHandler event:" + event);
      switch (event) {
        case 'mic-on':
          console.log("event: mic-on");
          return this.ls.getAudioTracks()[0].enabled = true;
        case 'mic-off':
          console.log("event: mic-off");
          return this.ls.getAudioTracks()[0].enabled = false;
        default:
          return console.log("event: unknown");
      }
    };

    return DeviceClass;

  })(BaseClass);
  return exports;
})();
