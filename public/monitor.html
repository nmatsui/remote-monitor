<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <title>Remote Monitor System (Monitor)</title>
  <link rel="stylesheet" href="stylesheets/style.css"/>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="javascripts/peer.js"></script>
  <script src="javascripts/remote-monitor.js"></script>
  <script>
    $(function() {
      var rm = new ns.RemoteMonitor();
      var mic = false;
      var cap = false;
      var sx = 0;
      var sy = 0;
      var drawing = false;

      function allhide() {
        $('#initialize').hide();
        $('#makecall-form').hide();
        $('#calling-form').hide();
        $('#device-video').hide();
        $('#monitor-video').hide();
        $('#capture-canvas').hide();
      }
      function initializing() {
        allhide();
        $('#initialize').show();
      }
      function waiting() {
        allhide();
        $('#makecall-form').show();
      }
      function connecting() {
        allhide();
        //$('#device-video').height($('html').prop('clientHeight'));
        //$('#device-video').width($('html').prop('clientWidth'));
        $('#device-video').show();
      }
      function showError(errmessage) {
        alert(errmessage);
      }
      function captureVideo(video, canvas) {
        var ctx = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
      }

      $('#make-call').click(function() {
        rm.makeCall($('#callto-id').val(), $('#device-video'), connecting, waiting);
        $('#makecall-form').hide();
        $('#calling-form').show();
      });
      $('#end-call').click(function() {
        rm.closeCall();
        $('#calling-form').hide();
        $('#makecall-form').show();
      });
      $('#toggle-mic').click(function() {
        rm.toggleMIC();
        mic = !mic;
        if (mic) {
          $('#toggle-mic').text('MIC OFF');
        }
        else {
          $('#toggle-mic').text('MIC ON');
        }
      });
      $('#toggle-capture').click(function() {
        cap = !cap;
        if (cap) {
          captureVideo($('#device-video')[0], $('#capture-canvas')[0]);

          $('#device-video').hide();
          $('#capture-canvas').show();
          $('#send-image').prop('disabled', false);
          $('#toggle-capture').text('LIVE');
        }
        else {
          rm.clearCapture();

          $('#capture-canvas').hide();
          $('#send-image').prop('disabled', true);
          $('#device-video').show();
          $('#toggle-capture').text('CAPTURE');
        }
      });
      $('#send-message').click(function() {
        rm.sendMessage($('#message').val());
      });
      $('#send-image').click(function() {
        var data = $('#capture-canvas')[0].toDataURL('image/png');
        rm.sendData(data);
      });
      $('#terminate').click(function() {
        rm.terminate();
        window.open('about:blank', '_self').close();
      });

      $('#capture-canvas').on('mousedown', function(e) {
        drawing = true;
        sx = e.pageX - $(this).offset().left;
        sy = e.pageY - $(this).offset().top;
        return false;
      });
      $('#capture-canvas').on('mousemove', function(e) {
        if (drawing) {
          var ctx = this.getContext('2d');
          var ex = e.pageX - $(this).offset().left;
          var ey = e.pageY - $(this).offset().top;
          ctx.lineWidth = 2;
          ctx.strokeStyle = 'rgb(255, 0, 0)';
          ctx.beginPath();
          ctx.moveTo(sx, sy);
          ctx.lineTo(ex, ey);
          ctx.stroke();
          ctx.closePath();
          sx = ex;
          sy = ey;
        }
      });
      $('#capture-canvas').on('mouseup', function() {
        drawing = false;
      });
      $('#capture-canvas').on('mouseleave', function() {
        drawing = false;
      });

      rm.onError(showError, waiting);

      rm.initialize($('#monitor-video'), initializing, waiting);
    });
  </script>
</head>
<body>
  <div id="initialize" class="text">
    <p>ビデオカメラとマイクを使います<br/>許可をクリックしてください</p>
  </div>
  <div id="caller" class="text">
    <div id="makecall-form">
      <p>デバイスのpeerjsIDを入力し、CALLしてください</p>
      <input type="text" placeholder="peerjsID" id="callto-id"/>
      <button id="make-call">CALL</button>
      <br/>
      <button id="terminate">TERMINATE</button>
    </div>
    <div id="calling-form">
      <button id="end-call">END CALL</button>
      <span class="separate">|</span>
      <button id="toggle-mic">MIC ON</button>
      <span class="separate">|</span>
      <input type="text" placeholder="message" id="message"/>
      <button id="send-message">SEND MESSAGE</button>
      <span class="separate">|</span>
      <button id="toggle-capture">CAPTURE</button>
      <button id="send-image" disabled="true">SEND IMAGE</button>
    </div>
  </div>
  <div id="video-container">
    <video id="device-video" class="center" autoplay></video>
    <video id="monitor-video" muted="true" autoplay></video>
  </div>
  <div id="capture-container">
    <canvas id="capture-canvas" class="center"></canvas>
  </div>
</body>
</html>
